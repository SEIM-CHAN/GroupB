{% extends 'nice_board/_base.html' %}

{% load static %}

{% block title %}{% if thread %}{{ thread.title }}{% endif %}{% endblock %}

{% block head %}
<style>
    .comment__number::after,
    .comment__user::after {
        content: ":";
    }
</style>
{% endblock %}

{% block contents %}
<div class="container mt-4">

    {% if thread %}
    <div class="row">
        <h2 class="col-6">{{ thread.title }}</h2>
        <div class="col-6">
            <ul class="row">
                <li class="col-12">作成者<span>{{ thread.user }}</span></li>
                <li class="col-12">作成日時<span>{{ thread.created_at }}</span></li>
            </ul>
        </div>
    </div>
    <div class="row">
        {% if thread.desc %}
        <p>{{ thread.desc }}</p>
        {% else %}
        <p>説明文はありません</p>
        {% endif %}
    </div>
    {% else %}
    <div class="row">
        <h2>スレッド情報がありません</h2>
    </div>
    {% endif %}
</div>
<div id="contents" class="container mt-4">
    {% for comment in comments %}
    {% if forloop.first %}
    <dl class="list-group">
        {% endif %}
        <div class="list-group-item list-group-item-wite">
            <div class="d-flex">
                <dt class="comment__number h5">{{ forloop.counter }}</dt>
                {% if comment.text %}
                {% if not comment.user %}
                <dd class="comment__user ms-3 h5">名無し</dd>
                {% else %}
                <dd class="comment__user ms-3 h5">{{ comment.user }}</dd>
                {% endif %}
                {% else %}
                <dd class="comment__user ms-3 h5">削除されました</dd>
                {% endif%}
                <dd class="ms-3 h5">{{ comment.created_at }}</dd>
                {% if not user.is_anonymous and comment.text %}
                <div class="ms-auto">
                    {% if thread.user.id == user.id or comment.user.id == user.id %}
                    <a class="btn btn-outline-danger btn-sm"
                        href="{% url 'nice_board:comment_update' thread.id comment.id %}" data-modal="">削除</a>
                    {% endif %}

                </div>
                {% endif %}


            </div>
            {% if not comment.text %}
            <dd class="comment__text">投稿は削除されました</dd>
            {% elif comment.ban %}
            <dd class="comment__text">管理者が非表示にしました</dd>
            {% else %}
            <dd class="comment__text">{{ comment.text | linebreaks }}</dd>
            {% endif %}
        </div>
        {% if forloop.last %}
    </dl>
    {% endif %}
    {% empty %}
    <div class="row">
        <p>投稿はまだありません</p>
    </div>
    {% endfor %}
</div>
<div id="commentCreateForm" class="container mt-4 mb-4">
    <a href="btn btn-primary">投稿</a>
</div>
{% endblock %}
{% block script %}
<script>
    const URL_COMMENTS = "{% url 'nice_board:comments' thread.id %}";
    const URL_CREATE_COMMENT_TOOL = "{% url 'nice_board:comment_create_tool' thread.id %}";
    $(function () {
        console.log("acttive")
        const list = new PageScript("#contents", "#contents", URL_COMMENTS);
        const form = new PageScript("#commentCreateForm", "#contents", URL_CREATE_COMMENT_TOOL);
        PageScript.ajaxGet(URL_CREATE_COMMENT_TOOL)
            .then(data => {
                function doneCreateView(resp, listInstans) {
                    const siteHtml = $(data).find(form.contentElName);
                    siteHtml.find("a").remove();
                    console.log(siteHtml.find("form"))
                    siteHtml.find("form").submit(function () {
                        const postData = {}
                        $(this).find("input").each(function () {
                            postData[$(this).attr("name")] = $(this).val()
                        })
                        $(this).find("textarea").each(function () {
                            postData[$(this).attr("name")] = $(this).val()
                        })

                        PageScript.ajaxPost(form.sendUrl, postData)
                            .then(resp2 => {
                                doneCreateView(resp2, listInstans)
                            }, resp2 => {
                                alert("送信に失敗しました");
                                form.outputEl.appent("問題がはっせいしました")
                            })
                            .then(() => {
                                PageScript.ajaxGet(listInstans.sendUrl)
                                    .then(resp2 => {
                                        listInstans.doneListView(resp2);
                                        $("a[data-modal]").click(modalAction)
                                    })
                            })
                        return false
                    });
                    form.outputEl.empty();
                    form.outputEl.append(siteHtml.children());
                }
                doneCreateView(data, list)
            }, resp => { alert("error 投稿はページ遷移で投稿してください") });

        const URL_MANAGE = "{% url 'nice_board:thread_manage' %}"
        const myModal = new bootstrap.Modal(document.getElementById('staticBackdrop'), {
            keyboard: false
        })

        const modal = new PageScript("#modalBody", "#contents", "");
        function modalAction() {
            event.stopPropagation();
            modal.sendUrl = $(this).attr('href');
            PageScript.ajaxGet(modal.sendUrl)
                .then(data => {
                    myModal.toggle();
                    const _this = this;
                    const siteHtml = $(data).find(modal.contentElName);
                    siteHtml.find("form").submit(function () {
                        const postData = {}
                        $(this).find("input").each(function () {
                            postData[$(this).attr("name")] = $(this).val()
                        })
                        $(this).find("textarea").each(function () {
                            postData[$(this).attr("name")] = $(this).val()
                        })
                        PageScript.ajaxPost(modal.sendUrl, postData)
                            .then(data => {
                                PageScript.ajaxGet(URL_COMMENTS)
                                    .then(data => {
                                        list.doneListView(data)
                                        myModal.toggle();
                                        $("a[data-modal]").click(modalAction);
                                    })
                            },
                                resp => { })
                        return false
                    });
                    $(modal.outputEl).empty();
                    $(modal.outputEl).append(siteHtml.children());
                }, resp => {
                    console.log("huga")
                })
            return false
        }
        $("a[data-modal]").click(modalAction)
    });
</script>
{% endblock %}